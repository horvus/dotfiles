
<!DOCTYPE HTML>
<html>
 <head>
   

<link type="text/css" href="/site_static/css/booki.css" rel="Stylesheet" >
<link type="text/css" href="/site_static/js/jquery/themes/base/jquery.ui.all.css" rel="Stylesheet" >
<link type="text/css" href="/site_static/js/jquery/themes/smoothness/jquery.ui.all.css" rel="Stylesheet" >
<script type="text/javascript" src="/site_static/js/jquery/jquery-1.4.4.js"></script>
<script type="text/javascript" src="/site_static/js/jquery/ui/jquery-ui-1.8.10.custom.js"></script>
<script type="text/javascript" src="/site_static/js/jquery.json-1.3.js"></script>
<script type="text/javascript" src="/site_static/js/booki.js"></script>
<script src="/site_static/js/messaging.js" type="text/javascript"></script>   
<script type="text/javascript" src="/site_static/js/general.js"></script>
<link href="/site_static/css/jquery.bubblepopup.v2.3.1.css" rel="stylesheet" type="text/css" />
<link type="text/css" href="/site_static/css/jquery-ui_overrides.css" rel="Stylesheet" >
<script src="/site_static/js/jquery.bubblepopup.v2.3.1.min.js" type="text/javascript"></script>

<link rel="SHORTCUT ICON" href="http://write.flossmanuals.net/site_static/images/favicon.ico" type="image/x-icon">
<meta property="og:site_name" content="FLOSS Manuals"/><meta name="description" content="Free Manuals for Freedom"/>

<script type="text/javascript">
  $(function() {
      $.booki.sputnikDispatcherURL = "/_sputnik/";

      $("#dialog-sputnik-error").dialog({
          modal: true,
          autoOpen: false,
          buttons: {
            Ok: function() {
               $(this).dialog('close');
               window.location = '.';
            }
          }
      });
  
      $("FORM.messagefield").messagefield('init', {'view_post': '/messaging/post' });  
  });
</script>


   
<title>/chapter: Making-Your-Own-Interpreter / COMMAND LINE</title>
<link type="text/css" href="/site_static/css/published.css" rel="Stylesheet" />

<link rel="alternate" type="application/rss+xml" title="RSS feed for COMMAND LINE" href="/feeds/rss/book/command-line/" /> 
<link rel="alternate" type="application/atom+xml" title="Atom feed for COMMAND LINE" href="/feeds/atom/book/command-line/" /> 

<link rel="alternate" type="application/rss+xml" title="RSS feed for chapter MAKING YOUR OWN INTERPRETER" href="/feeds/rss/chapter/command-line/command-line/" /> 
<link rel="alternate" type="application/atom+xml" title="Atom feed for chapter MAKING YOUR OWN INTERPRETER" href="/feeds/atom/chapter/command-line/command-line/" /> 


<style>
SPAN.bookicommentmarker {
  background-color: white;
}

SPAN.bookicommentmarker > IMG.markerimage { 
   display: none;
}


</style>



   <link type="text/css" href="/static/css/_user.css" rel="Stylesheet" >
 </head>
<body>

<div class="topbar"> 
  <div class="logotext"><a href="http://write.flossmanuals.net/">FLOSS Manuals</a> </div>

  <div class="meta-bar">
    
    <ul>
      <li>
        <a href="/accounts/signin/?redirect=/command-line/making-your-own-interpreter/">Sign In / Create Account</a>
      </li>
    </ul>
    
    <div style="padding-top: 10px; padding-right: 15px;">
      <br/>
      

<script>
  $(function() {
    var $frm = $("FORM[name=changelang]");
	
    $("A[href=#]", $frm).click(function() {
        var lang = $(this).attr("class").substr(4);
	
        $("INPUT[name=language]", $frm).val(lang);
        $frm.submit();
	
        return false;
    });
  });
 </script>

<form name="changelang" method="POST" action="/accounts/i18n/setlang/?language=en-us">
  <input type="hidden" name="language" value="en-us">
  
    &nbsp;English&nbsp;|
  
  
  
    &nbsp;<a class="langes" href="#">Español</a>&nbsp;|
  

  
    &nbsp;<a class="langfr" href="#">Français</a>&nbsp;|
  
	
  
    &nbsp;<a class="langit" href="#">Italiano</a>&nbsp;|
  
	
  
    &nbsp;<a class="langpt" href="#">Português</a>&nbsp;|
  
	
  
    &nbsp;<a class="langru" href="#">Русский</a>&nbsp;|
  
	
  
    &nbsp;<a class="langsq" href="#">Shqip</a>
  	
</form>

    </div>
    
    
  </div><!-- End of .meta-bar -->
</div><!-- End top bar -->

<div class="menubar shadow">
  
  
  <div class="navbox">
    <ul>
      <li><a href="/list-books/">Books</a></li>
      <li><a href="/list-groups/">Groups</a></li>
      <li><a href="/list-people/">People</a></li>
    </ul>      
  </div><!-- End of .navbox -->       
</div>

<div class="content-container">
  <div class="content shadow">
    <!-- Content box and the drop shadow-->
    
   <h2>COMMAND LINE</h2>

<div class="padded">
<div id="bookmenu">
<ul>

 
   <li><b>INTRODUCTION</b></li>
 

 
   <li><a href="/command-line/introduction/">INTRODUCTION</a></li>
 

 
   <li><a href="/command-line/about-this-manual/">ABOUT THIS  MANUAL</a></li>
 

 
   <li><b>BASICS</b></li>
 

 
   <li><a href="/command-line/getting-started/">GETTING STARTED</a></li>
 

 
   <li><a href="/command-line/beginning-syntax/">BEGINNING SYNTAX</a></li>
 

 
   <li><a href="/command-line/moving-around/">MOVING AROUND</a></li>
 

 
   <li><b>COMMANDS</b></li>
 

 
   <li><a href="/command-line/basic-commands/">BASIC COMMANDS</a></li>
 

 
   <li><a href="/command-line/standard-files/">STANDARD FILES</a></li>
 

 
   <li><a href="/command-line/cut-down-on-typing/">CUT DOWN ON TYPING</a></li>
 

 
   <li><a href="/command-line/superusers/">SUPERUSERS</a></li>
 

 
   <li><a href="/command-line/redirection/">REDIRECTION</a></li>
 

 
   <li><b>ADVANCED-ISH</b></li>
 

 
   <li><a href="/command-line/multiple-files/">MULTIPLE FILES</a></li>
 

 
   <li><a href="/command-line/searching-for-files/">SEARCHING FOR FILES</a></li>
 

 
   <li><a href="/command-line/piping/">PIPING</a></li>
 

 
   <li><a href="/command-line/processes/">PROCESSES</a></li>
 

 
   <li><a href="/command-line/file-structure/">FILE STRUCTURE</a></li>
 

 
   <li><a href="/command-line/command-history/">COMMAND HISTORY</a></li>
 

 
   <li><b>ADVANCED</b></li>
 

 
   <li><a href="/command-line/permissions/">PERMISSIONS</a></li>
 

 
   <li><a href="/command-line/interactive-editing/">INTERACTIVE EDITING</a></li>
 

 
   <li><a href="/command-line/checking-exit/">CHECKING EXIT</a></li>
 

 
   <li><a href="/command-line/sub-commands/">SUB COMMANDS</a></li>
 

 
   <li><a href="/command-line/moving-again/">MOVING AGAIN</a></li>
 

 
   <li><a href="/command-line/customisation/">CUSTOMISATION</a></li>
 

 
   <li><a href="/command-line/parameter-substitution/">PARAMETER SUBSTITUTION</a></li>
 

 
   <li><a href="/command-line/gnuscreen/">GNUSCREEN</a></li>
 

 
   <li><a href="/command-line/ssh/">SSH</a></li>
 

 
   <li><a href="/command-line/installing-software/">INSTALLING SOFTWARE</a></li>
 

 
   <li><a href="/command-line/making-your-own-interpreter/">MAKING YOUR OWN INTERPRETER</a></li>
 

 
   <li><b>TEXT EDITORS</b></li>
 

 
   <li><a href="/command-line/text-editors/">TEXT EDITORS</a></li>
 

 
   <li><a href="/command-line/nano/">NANO</a></li>
 

 
   <li><a href="/command-line/vim/">VIM</a></li>
 

 
   <li><a href="/command-line/emacs/">EMACS</a></li>
 

 
   <li><a href="/command-line/kedit/">KEDIT</a></li>
 

 
   <li><a href="/command-line/gedit/">GEDIT</a></li>
 

 
   <li><b>SCRIPTING</b></li>
 

 
   <li><a href="/command-line/scripting/">SCRIPTING</a></li>
 

 
   <li><a href="/command-line/maintaining-scripts/">MAINTAINING SCRIPTS</a></li>
 

 
   <li><a href="/command-line/other-languages/">OTHER LANGUAGES</a></li>
 

 
   <li><a href="/command-line/sed/">SED</a></li>
 

 
   <li><a href="/command-line/awk/">AWK</a></li>
 

 
   <li><a href="/command-line/regular-expressions/">REGULAR EXPRESSIONS</a></li>
 

 
   <li><b>SCRIPTING LANGUAGES</b></li>
 

 
   <li><a href="/command-line/perl/">PERL</a></li>
 

 
   <li><a href="/command-line/python/">PYTHON</a></li>
 

 
   <li><a href="/command-line/ruby/">RUBY</a></li>
 

 
   <li><a href="/command-line/gnu-octave/">GNU OCTAVE</a></li>
 

 
   <li><b>APPENDICES</b></li>
 

 
   <li><a href="/command-line/glossary/">GLOSSARY</a></li>
 

 
   <li><a href="/command-line/command-quickie/">COMMAND QUICKIE</a></li>
 

 
   <li><a href="/command-line/outline/">OUTLINE</a></li>
 

 
   <li><a href="/command-line/credits/">CREDITS</a></li>
 

</ul>
</div>
<div id="bookcontent">
   
<html dir="LTR"><head><title>CommandLineIntro: CreatingANewCommandInterpreter</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body>
<h1>Making Your Own Interpreter
  <br></h1>
<p>The bash shell and many other programs obtain lines of command input from the keyboard or a file, and then interpret them. In the case of keyboard input, editing facility is provided (or should be). Often this is done by using the readline library. Here we present a simple calculator program which uses command lines. You can lift the C source code out of this manual, put it in a file and compile and run it in order to study the construction and use of a command line interpreter. The tremendous advantages that this programming approach gives relative to the GUI approach have been discussed elsewhere in this manual. With bdc you can recall and re-execute complicated calculations, and you can make script files in which such calculations are saved.
</p>
<p> This is the source code, written for GNU-Linux:
  <br></p>
<pre><p>/* The Brain-Dead Calculator.
  Build:
gcc -g -O -Wall -o bdc bdc.c -lm -lreadline -lcurses
  Run:
./bdc    or   ./bdc path-to-command-file   or   path-to-exe-bdc-command-file
  Example commands:
3 q c -2.15 * s +     # calculates sqrt(3) + sin(-2.15*sqrt(3))
?                     # prints help message
*/
#define _GNU_SOURCE
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;readline/readline.h&gt;
#include &lt;readline/history.h&gt;
#include &lt;math.h&gt;
#include &lt;string.h&gt;

#define MAXLEVS 12
int levs = 8;
double st[MAXLEVS];

int do_file( char *path );

int parse( char *comm )
{
  int cc, pop, ii, ps;
  int cp = 0, cp0;
  int cl = strlen(comm);
  double rollin;
  char *endp, *comfile;

  if ( !cl ) return 0;
  do {
    rollin = 0.0;  pop = 1;
    cc = comm[cp];
    switch( cc ) {
      default:  if ( (cc &gt;= '0') &amp;&amp; (cc &lt;= '9') ) goto num;
        printf( "\nERROR at input position %d\n", cp );
        pop = 5;  break;
      case '#':
        pop = 3;  break;
      case '?':  printf(
"\nBrain-Dead Calculator with %d-level stack;  x=quit\n", levs );
                 printf(
"op=  + - * /   perform arithmetic:"
"   st[1] = st[1] op st[0]   and shift st[j-1] &lt;-- st[j]\n"
"op=   s  q     perform functions:"
"  st[0] = func(st[0])  s= sine  q= square-root\n"
"op=   d c r    manipulate stack:"
"  d= discard st[0];  c= copy st[0];  r= rotate st[j-1] &lt;-- st[j]\n"
"op=   &amp;path    run the command file specified by path\n" );
      case ' ':  pop = 0;  break;
      case '+':  if ( (comm[cp+1] &gt;= '0') &amp;&amp; (comm[cp+1] &lt;= '9') ) { num:
          memmove( st+1, st, (levs-1)*sizeof(double) );
          st[0] = strtod( comm+cp, &amp;endp );
          cp += (endp-(comm+cp))-1;
          pop = 0;  break;
        }
        st[1] += st[0];  break;
      case '-':  if ( (comm[cp+1] &gt;= '0') &amp;&amp; (comm[cp+1] &lt;= '9') ) goto num;
        st[1] -= st[0];  break;
      case '.':  goto num;
      case '*':  st[1] *= st[0];  break;
      case '/':  st[1] /= st[0];  break;
      case 'q':  st[0] = sqrt(st[0]);  pop = 0;  break;
      case 's':  st[0] = sin(st[0]);  pop = 0;  break;
      case 'd':  break;
      case 'c':  memmove( st+1, st, (levs-1)*sizeof(double) );
                 pop = 0;  break;
      case 'r':  pop = 2;  break;
      case '&amp;':
        ii = 0;  cp += 1;  cp0 = cp;
        while ( comm[cp] &gt; ' ' ) {
          cp += 1;  ii += 1;
        }
        comfile = malloc( ii+1 );  // we really should check malloc failure
        memcpy( comfile, comm+cp0, ii );  comfile[ii] = 0;
        ps = do_file( comfile );
        free( comfile );
        pop = 0;  break;
      case 'x':  pop = 4;  break;
    }
    switch( pop ) {
      case 0:  break;
      case 2:  rollin = st[0];
      case 1:  memmove( st, st+1, (levs-1)*sizeof(double) );
               st[levs-1] = rollin;  break;
      default:  return pop;
    }
    cp += 1;
  } while ( cp &lt; cl );
  return 0;
}

int do_file( char *path )
{
  FILE *do_fb;
  char *comm;
  ssize_t len;  size_t len1;
  int  ps, ii, comcount = 0;

  do_fb = fopen( path, "r" );
  if ( !do_fb ) {
    perror( "do_file: cannot open" );
    return 0;
  }
  do {
    comm = NULL;
    len = getline( &amp;comm, &amp;len1, do_fb );
    if ( len == -1 ) { ps = 0;  break; }
    comm[len-1] = 0;
    ps = parse( comm );
    free( comm );  comcount += 1;
  } while ( (ps != 4) &amp;&amp; (ps != 5) );
  fclose( do_fb );  // we really should check for fclose failure
  printf( "file %d st=", comcount );
  for ( ii = 0;  ii &lt; levs;  ii++ ) printf( "  %g", st[ii] );
  printf( "\n" );
  return ps;
}

int main( int argc, char **argv )
{
  char *comm;
  int ii, ps, comcount=0;

  if ( argc &gt; 1 ) {
    ps = do_file( argv[1] );
    if ( ps == 4 ) return 0;
    if ( ps == 5 ) return 1;
  }
  do {
    do {
      comm = readline( "bdc&gt; " );
    } while ( comm == NULL );
    add_history( comm );
    ps = parse( comm );
    free( comm );  comcount += 1;
    printf( "comm %d st=", comcount );
    for ( ii = 0;  ii &lt; levs;  ii++ ) printf( "  %g", st[ii] );
    printf( "\n" );
  } while ( ps != 4 );
  return 0;
}

</p>
</pre>
<p>
</p>
<p> Here are instructions for building and running bdc. We are doing it in /tmp just for concreteness, but you could put it anywhere. 
</p>
<ul><li>Lift the source out of this manual and put it in the file /tmp/bdc.c</li>
  <li>cd to /tmp</li>
  <li>Build the program by running the gcc command shown in the comment at top of bdc.c</li>
  <li>Run the program by typing <strong>./bdc</strong></li>
  <li><strong></strong> Give bdc commands strings at the <strong>bdc&gt;</strong> prompt, such as <em>1.23 s 3 + q</em></li>
</ul><em></em>
<ul><li>To quit, use the <em>x</em> command</li>
</ul><p>The bdc command interpreter starts at the beginning of a command string and processes commands and numbers until it gets to the end (or an error). It maintains a stack of numbers, and commands act on them in various ways. The command interpreter is called in two places: a loop that gets command strings from a file, and a loop that gets command strings from the keyboard. The keyboard input is obtained by readline, and the strings are stored in a history list. Therefore, commands can be edited just like shell commands, and previous ones can be recalled.
</p>
<p>Here is a small bdc command file. Lift it out and put it in /tmp/example.bdc. Then you can run it by typing <strong>&amp;example.bdc</strong> on the bdc command line. You can also run it from the shell by typing <strong>./bdc example.bdc</strong>. It will perform the calculations, display the resulting stack and give an input prompt. You can then do more calculations. If you make it executable (<strong>chmod +x example.bdc</strong>) you can start bdc from the shell by typing <strong>./example.bdc</strong>. This has the same effect as typing <strong>./bdc example.bdc</strong>; in both cases the shell starts the bdc program and passes "example.bdc" as an argument.
  <br></p>
<p>
</p>
<pre>#!/tmp/bdc
# Calculate sin(1.5+sqrt(3.14))*7.9
3.14 q 1.5 + s 7.9 *
# Calculate sqrt(5+(previous result))
c 5 t + q
</pre>
<p>
</p>
<p>
</p>For simplicity we have used only one-character commands, and very few of them. The experix project on SourceForge is a much more capable calculator. Its stack can hold numbers, arrays, strings, file controls and other things, and its operators and commands do what makes sense with the stack arguments that they get. There are comparison and conditional branch operators so that experix command strings can be full-fledged programs. Stack objects and command sequences can be packaged in variables and then invoked by name. It draws graphs and writes text on a framebuffer screen, using a separate server program. In order to see the command line on the graphics screen, characters from stdout are packaged into server commands. Some of the command files demonstrate the technique of passing arguments to experix by including them on the "#!..." line of the command file. Installation of experix is far from being simple and automated, but help is available by contacting the author.
<br><p>
</p>
<p> 
</p>
</body></html>
   

</div>
</div>

  </div>
</div>
<!-- End of content -->



<!-- sputnik error page -->
<div id="dialog-sputnik-qrac" style="display: none"></div>
<div id="dialog-sputnik-error" title="Can't communicate with booktype">
  <p>
    <span class="ui-icon ui-icon-circle-check" style="float:left; margin:0 7px 50px 0;"></span>
    There has been error in communication with Booktype server.
    Not sure right now where is the problem.
  </p>
  <p>
    You should refresh this page.
  </p>
</div>


<ul class="strings template">
 <li class="ok">OK</li>
 <li class="back">Back</li>
 <li class="create">Create</li>
 <li class="cancel">Cancel</li>
 <li class="next">Next</li>
 <li class="import">Import</li>
 <li class="savechanges">Save changes</li>
 <li class="errorcreategroup">Couldn't create a group!</li>
 <li class="msgepub">enter epub URL</li>
 <li class="msgarchive">enter Archive.org ID</li>
 <li class="msgwiki">enter Wikibooks URL</li>
 <li class="msgbooktype">enter Booktype URL</li>
 <li class="deletebook">Delete book</li>
</ul>

</body>
</html>

