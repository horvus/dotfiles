
<!DOCTYPE HTML>
<html>
 <head>
   

<link type="text/css" href="/site_static/css/booki.css" rel="Stylesheet" >
<link type="text/css" href="/site_static/js/jquery/themes/base/jquery.ui.all.css" rel="Stylesheet" >
<link type="text/css" href="/site_static/js/jquery/themes/smoothness/jquery.ui.all.css" rel="Stylesheet" >
<script type="text/javascript" src="/site_static/js/jquery/jquery-1.4.4.js"></script>
<script type="text/javascript" src="/site_static/js/jquery/ui/jquery-ui-1.8.10.custom.js"></script>
<script type="text/javascript" src="/site_static/js/jquery.json-1.3.js"></script>
<script type="text/javascript" src="/site_static/js/booki.js"></script>
<script src="/site_static/js/messaging.js" type="text/javascript"></script>   
<script type="text/javascript" src="/site_static/js/general.js"></script>
<link href="/site_static/css/jquery.bubblepopup.v2.3.1.css" rel="stylesheet" type="text/css" />
<link type="text/css" href="/site_static/css/jquery-ui_overrides.css" rel="Stylesheet" >
<script src="/site_static/js/jquery.bubblepopup.v2.3.1.min.js" type="text/javascript"></script>

<link rel="SHORTCUT ICON" href="http://write.flossmanuals.net/site_static/images/favicon.ico" type="image/x-icon">
<meta property="og:site_name" content="FLOSS Manuals"/><meta name="description" content="Free Manuals for Freedom"/>

<script type="text/javascript">
  $(function() {
      $.booki.sputnikDispatcherURL = "/_sputnik/";

      $("#dialog-sputnik-error").dialog({
          modal: true,
          autoOpen: false,
          buttons: {
            Ok: function() {
               $(this).dialog('close');
               window.location = '.';
            }
          }
      });
  
      $("FORM.messagefield").messagefield('init', {'view_post': '/messaging/post' });  
  });
</script>


   
 <title>/chapter: Using-Ffmpeg-And-Avconfv / A Look at Open Video</title>
 <link type="text/css" href="/site_static/css/draft.css" rel="Stylesheet" />

 <link rel="alternate" type="application/rss+xml" title="RSS feed for A Look at Open Video" href="/feeds/rss/book/a-look-at-open-video/" /> 
 <link rel="alternate" type="application/atom+xml" title="Atom feed for A Look at Open Video" href="/feeds/atom/book/a-look-at-open-video/" /> 

 <link rel="alternate" type="application/rss+xml" title="RSS feed for chapter Using ffmpeg and avconfv" href="/feeds/rss/chapter/a-look-at-open-video/a-look-at-open-video/" /> 
 <link rel="alternate" type="application/atom+xml" title="Atom feed for chapter Using ffmpeg and avconfv" href="/feeds/atom/chapter/a-look-at-open-video/a-look-at-open-video/" /> 
 
 <script type="text/javascript" src="/site_static/js/draft.js"></script>


   <link type="text/css" href="/static/css/_user.css" rel="Stylesheet" >
 </head>
<body>

<div class="topbar"> 
  <div class="logotext"><a href="http://write.flossmanuals.net/">FLOSS Manuals</a> </div>

  <div class="meta-bar">
    
    <ul>
      <li>
        <a href="/accounts/signin/?redirect=/a-look-at-open-video/_draft/_v/1.0/using-ffmpeg-and-avconfv/">Sign In / Create Account</a>
      </li>
    </ul>
    
    <div style="padding-top: 10px; padding-right: 15px;">
      <br/>
      

<script>
  $(function() {
    var $frm = $("FORM[name=changelang]");
	
    $("A[href=#]", $frm).click(function() {
        var lang = $(this).attr("class").substr(4);
	
        $("INPUT[name=language]", $frm).val(lang);
        $frm.submit();
	
        return false;
    });
  });
 </script>

<form name="changelang" method="POST" action="/accounts/i18n/setlang/?language=en-us">
  <input type="hidden" name="language" value="en-us">
  
    &nbsp;English&nbsp;|
  
  
  
    &nbsp;<a class="langes" href="#">Español</a>&nbsp;|
  

  
    &nbsp;<a class="langfr" href="#">Français</a>&nbsp;|
  
	
  
    &nbsp;<a class="langit" href="#">Italiano</a>&nbsp;|
  
	
  
    &nbsp;<a class="langpt" href="#">Português</a>&nbsp;|
  
	
  
    &nbsp;<a class="langru" href="#">Русский</a>&nbsp;|
  
	
  
    &nbsp;<a class="langsq" href="#">Shqip</a>
  	
</form>

    </div>
    
    
  </div><!-- End of .meta-bar -->
</div><!-- End top bar -->

<div class="menubar shadow">
  
  
  <div class="navbox">
    <ul>
      <li><a href="/list-books/">Books</a></li>
      <li><a href="/list-groups/">Groups</a></li>
      <li><a href="/list-people/">People</a></li>
    </ul>      
  </div><!-- End of .navbox -->       
</div>

<div class="content-container">
  <div class="content shadow">
    <!-- Content box and the drop shadow-->
    

<h2>A Look at Open Video</h2>
<div class="padded">
 <div id="bookmenu" style="background: url(/site_static/images/draft_bg.png) repeat !important;"> 
  <ul>
   
    
      <li><b>Part One</b></li>
    
   
    
      <li><a href="/a-look-at-open-video/_draft/_v/1.0/a-look-at-open-video/">A Look at Open Video</a></li>
    
   
    
      <li><a href="/a-look-at-open-video/_draft/_v/1.0/what-is-open-video/">What is Open Video?</a></li>
    
   
    
      <li><a href="/a-look-at-open-video/_draft/_v/1.0/understanding-video-files/">Understanding Video Files</a></li>
    
   
    
      <li><a href="/a-look-at-open-video/_draft/_v/1.0/creating-open-subtitles/">Creating Open Subtitles</a></li>
    
   
    
      <li><a href="/a-look-at-open-video/_draft/_v/1.0/understanding-codecs-and-containers/">Understanding Codecs and Containers</a></li>
    
   
    
      <li><a href="/a-look-at-open-video/_draft/_v/1.0/tools-for-creating-open-video-files/">Tools for Creating Open Video Files</a></li>
    
   
    
      <li><a href="/a-look-at-open-video/_draft/_v/1.0/encoding-explained/">Encoding Explained</a></li>
    
   
    
      <li><b>Part Two</b></li>
    
   
    
      <li><a href="/a-look-at-open-video/_draft/_v/1.0/a-look-at-open-video-part-two/">A Look at Open Video - Part Two </a></li>
    
   
    
      <li><a href="/a-look-at-open-video/_draft/_v/1.0/taking-video-to-the-web/">Taking Video to the Web</a></li>
    
   
    
      <li><a href="/a-look-at-open-video/_draft/_v/1.0/video-and-html5-markup/">Video and HTML5 Markup</a></li>
    
   
    
      <li><a href="/a-look-at-open-video/_draft/_v/1.0/collecting-and-moving-video-metadata/">Collecting and Moving Video Metadata</a></li>
    
   
    
      <li><a href="/a-look-at-open-video/_draft/_v/1.0/using-ffmpeg-and-avconfv/">Using ffmpeg and avconfv</a></li>
    
   
    
      <li><a href="/a-look-at-open-video/_draft/_v/1.0/what-next-for-open-video/">What Next for Open Video</a></li>
    
   
    
      <li><a href="/a-look-at-open-video/_draft/_v/1.0/course-process-credits/">Course Process &amp; Credits</a></li>
    
   
  </ul>
 </div>
 <div id="bookcontent"   style="background: url(/site_static/images/draft_bg.png) repeat !important;">
   

  <html><body><h1>Using ffmpeg and avconv
</h1>
<p> A hands on look at command line encoding. While this chapter was always going to be challenging to write and we invite you to help us improve it. We hope we have some good materials here which act as a base to look at the subject.
</p>
<p><img src="static/dumbledad_flickr_600.jpg"> 
</p>
<p>ffmpeg and avconv (a more updated version of ffmpeg) are the command line applications that are working in the back end of many desktop encoding applications. These include ffmpegX, Handbrake, SUPER encoder. It is also essential for many desktop video editing applications including Kdenlive.
  <br></p>
<p>These tools can also be a very handy to work with video on Internet servers. As you will see later in the chapter you will be able to do more than just transcode video from one file type to another.
</p>
<h3>Installing ffmpeg / avconv
  <br></h3>
<p>To start playing around with FFmpeg you will need to install it. It is best suited to use of a linux based server or desktop but it is possible on windows and osx. A search engine can help you with the specifics of how to install it. Search for  <a _cke_saved_href="https://www.google.co.uk/search?q=install+ffmpeg">"install ffmpeg + <em>your operating system</em>" </a>
  <br></p>
<p>
</p>
<p>
</p>
<h3> WebM settings
  <br></h3>
<p> For an overview of usefull ffmpeg/avconv options related to encoding WebM files. <a href="http://wiki.webmproject.org/ffmpeg">http://wiki.webmproject.org/ffmpeg</a> and <a href="http://ffmpeg.org/ffmpeg.html#libvpx">http://ffmpeg.org/ffmpeg.html#libvpx</a>
</p>
<p> <a href="http://rodrigopolo.com/ffmpeg/cheats.html">http://rodrigopolo.com/ffmpeg/cheats.html</a>
</p>
<h3> H264 settings
</h3>
<p>For a guide on creating h264 files that work on many mobile devices<a href="http://h264.code-shop.com/trac/wiki/Encoding"> - http://h264.code-shop.com/trac/wiki/Encoding</a>. For a general x264 encoding guide see - <a href="http://ffmpeg.org/trac/ffmpeg/wiki/x264EncodingGuide">http://ffmpeg.org/trac/ffmpeg/wiki/x264EncodingGuide</a>
</p>
<h2>ffmpeg and numpy
</h2>
<p>This guide written by RMO is a good introduction to taking your work with ffmpeg to another level on the server. 
  <br></p>
<p> In the past year and a half, <a href="http://numm.org/~daf">daf</a> and I have undertaken a series of media experiments using <a href="http://python.org">python</a>'s excellent <a href="http://scipy.org">numpy</a> library. The outcome of these trials are largely encapsulated in our <a href="http://numm.org/numm/">numm</a> project, which is available in the <a href="http://debian.org">debian</a> and <a href="http://ubuntu.com">ubuntu</a> repositories as <samp>python-numm</samp>.
</p>
<p> Numm uses <a href="http://gstreamer.org">gstreamer</a> for a/v decoding and encoding, as well as a minimalist livecoding API, but in the interests of simplicity and portability, I've been reimplementing some of the core functionality as a wrapper around the <a href="http://ffmpeg.org">ffmpeg</a> binary.
</p>
<h2>loading a video as numpy arrays
</h2>
<pre>import numpy as np
import subprocess

def video_frames(path, width=320, height=240, fps=30):
    cmd = ['ffmpeg', '-i', path,
           '-vf', 'scale=%d:%d'%(width,height),
           '-r', str(fps),
           '-an',
           '-c:v', 'rawvideo', '-f', 'rawvideo',
           '-pix_fmt', 'rgb24',
           '-']
    p = subprocess.Popen(cmd, stdout=subprocess.PIPE)
    while True:
        arr = np.fromstring(p.stdout.read(width*height*3), dtype=np.uint8)
        if len(arr) == 0:
            p.wait()
            return

        yield arr.reshape((height, width, 3))
</pre>
<h2>saving frames as images
</h2> Our <samp>video_frames</samp> function gives us numpy buffers from a video file. Each buffer is a 3-d array -- height, width, color -- with 8-bit intensity values. To save numpy buffers as images, we use the <a href="http://effbot.org/zone/pil-index.htm">Python Imaging Library</a> to define a np2image function (from <a href="http://git.numm.org/?p=numm.git;a=blob;f=numm/image.py;h=c410c9083af0b66bbd5c2c2cd5e9ec51c59bff90;hb=HEAD">image.py</a>):
<pre>import Image
def np2image(np, path):
    im = Image.fromstring(
        'RGB', (np.shape[1], np.shape[0]), np.tostring())
    im.save(path)
</pre> For example, to save a video as a directory full of still images:
<pre>for idx, fr in enumerate(video_to_frames(path)):
    np2image(fr, '%06d.jpg' % (idx))
</pre>
<h2>encoding numpy arrays to video
</h2> Alternatively, we can write a series of frames back to disk as a video:
<pre>def frames_to_video(generator, path, fps=30, ffopts=[]):
    p = None
    for fr in generator:
        if p is None:
            cmd =['ffmpeg', '-y', '-s', '%dx%d' % (fr.shape[1], fr.shape[0]),
                  '-r', str(fps),
                  '-an',
                  '-c:v', 'rawvideo', '-f', 'rawvideo',
                  '-pix_fmt', 'rgb24',
                  '-i', '-'] + ffopts + [path]
            p = subprocess.Popen(cmd, stdin=subprocess.PIPE)
        p.stdin.write(fr.tostring())
    p.stdin.close()
    p.wait()
</pre>
<h2>a simple test
</h2> Assuming you've saved these functions to a file (see <a href="http://git.numm.org/?p=numm.git;a=blob;f=numm/video.py;h=e1a17d17d10d14307665bf509d02dd614851d3cb;hb=refs/heads/numm2">here</a>) and imported them, we can re-encode a video:
<pre>frames_to_video(
    video_to_frames('/path/to/input/video.avi'),
    '/path/to/output/video.webm')
</pre> And ffmpeg encoding parameters can be added as needed, though this is <em>not</em> an efficient or in any way recommended method to transcode videos.
<pre>frames_to_video(
    video_to_frames('/path/to/input/video.avi'),
    '/path/to/output/video.webm', ffopts=['-vb', '500K']) # &amp;c.
</pre>
<h2>video synopses
</h2> Here are a few quick examples of the processing you can do by thinking about video as a series of arrays.
<h3>composite image
</h3> The average frame in a video:
<pre>INPUT_VIDEO = '/path/to/video'
W, H = (320, 240)

comp = np.zeros((H, W, 3), dtype=int)
nframes = 0
for fr in video_frames(INPUT_VIDEO, width=W, height=H):
    comp += fr
    nframes += 1
comp = (comp / nframes).astype(np.uint8)
np2image(comp, INPUT_VIDEO + '-comp.png')
</pre> <img src="http://numm.org/~rmo/ffmpeg-and-numpy/composite.png"><h3>scans
</h3> <a href="http://www.flong.com/texts/lists/slit_scan/">Slitscans</a> and <a href="https://pan.do/ra#tour.17">0xScans</a> are pixel-wide sweeps through a video:
<pre>slits = []
oxscan = []
for fr in video_frames(INPUT_VIDEO, width=W, height=H):
    slits.append(fr[:,W/2])
    oxscan.append(fr.mean(axis=1).astype(np.uint8))
slits = np.array(slits).transpose(1,0,2)
oxscan = np.array(oxscan).transpose(1,0,2)
np2image(slits, INPUT_VIDEO + '-slitscan.png')
np2image(oxscan, INPUT_VIDEO + '-oxscan.png')
</pre>
<h2>Task- Do something with ffmpeg / avconv
  <br></h2>
<p> Do something freaky (or normal for that matter) with ffmpeg / avconv and paste in the command line input you used as a comment or blog post.
</p></body></html>
   
  </div>
 </div>


  </div>
</div>
<!-- End of content -->



<!-- sputnik error page -->
<div id="dialog-sputnik-qrac" style="display: none"></div>
<div id="dialog-sputnik-error" title="Can't communicate with booktype">
  <p>
    <span class="ui-icon ui-icon-circle-check" style="float:left; margin:0 7px 50px 0;"></span>
    There has been error in communication with Booktype server.
    Not sure right now where is the problem.
  </p>
  <p>
    You should refresh this page.
  </p>
</div>


<ul class="strings template">
 <li class="ok">OK</li>
 <li class="back">Back</li>
 <li class="create">Create</li>
 <li class="cancel">Cancel</li>
 <li class="next">Next</li>
 <li class="import">Import</li>
 <li class="savechanges">Save changes</li>
 <li class="errorcreategroup">Couldn't create a group!</li>
 <li class="msgepub">enter epub URL</li>
 <li class="msgarchive">enter Archive.org ID</li>
 <li class="msgwiki">enter Wikibooks URL</li>
 <li class="msgbooktype">enter Booktype URL</li>
 <li class="deletebook">Delete book</li>
</ul>

</body>
</html>

